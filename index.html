<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photobooth - Alexis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; min-height: 100vh; margin: 0; padding: 0; background: #f3f4f6; overflow-x: hidden; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #1e40af; color: white; padding: 1rem 0.75rem; position: sticky; top: 0; z-index: 10; white-space: nowrap; text-align: center; font-size: 0.875rem; font-weight: 600; }
    td { padding: 0.875rem 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; }
    tbody tr:hover { background: #f9fafb; }
    .paid { background: #d1fae5; }
    .paid:hover { background: #a7f3d0 !important; }
    .notpaid { background: #fee2e2; }
    .notpaid:hover { background: #fecaca !important; }
  </style>
</head>
<body>

<div id="login" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-900 to-purple-900">
  <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full mx-4">
    <h1 class="text-4xl font-bold text-blue-900 mb-8">ğŸ‰ Photobooth</h1>
    <p class="text-gray-600 mb-2">Bienvenue Alexis</p>
    <p class="text-sm text-gray-500 mb-8">Gestion de vos rÃ©servations</p>
    <input id="password" type="password" class="w-full p-4 border-2 rounded-lg text-xl mb-2 focus:outline-none focus:border-blue-500" placeholder="Mot de passe">
    <div class="flex items-center mb-4">
      <input type="checkbox" id="showPassword" class="w-5 h-5 mr-3 cursor-pointer">
      <label for="showPassword" class="text-base text-gray-700 cursor-pointer select-none">Afficher le mot de passe</label>
    </div>
    <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg font-bold text-xl transition">Se connecter</button>
  </div>
</div>

<div id="app" class="hidden">
  <div class="bg-blue-900 shadow-lg">
    <div class="px-4 py-6 max-w-7xl mx-auto">
      <div class="flex flex-wrap justify-between items-center gap-4">
        <div>
          <h1 class="text-3xl font-bold text-white">ğŸ“‹ Mes RÃ©servations Photobooth</h1>
          <p class="text-blue-200 mt-1">Gestion complÃ¨te de mes locations</p>
        </div>
        <div class="flex gap-3 flex-wrap">
          <select id="filtre" class="px-4 py-2 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500 cursor-pointer">
            <option value="">Tous les mois</option>
          </select>
          <button id="newBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">+ Nouvelle rÃ©servation</button>
          <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition">ğŸšª DÃ©connexion</button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white min-h-screen">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ğŸ“… EnlÃ¨vement</th>
            <th>ğŸ“… Restitution</th>
            <th>ğŸ‘¤ Nom PrÃ©nom</th>
            <th>ğŸ“§ Email</th>
            <th>ğŸ“ TÃ©lÃ©phone</th>
            <th>ğŸ“ Adresse</th>
            <th>ğŸ­ Pseudo</th>
            <th>âœ… SignÃ©</th>
            <th>ğŸ’° Acompte</th>
            <th>ğŸ”’ Caution</th>
            <th>ğŸ¨ Template</th>
            <th>âš™ï¸ Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="12" class="text-center py-8 text-gray-500">Chargement...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-screen overflow-y-auto">
    <h2 class="text-3xl font-bold mb-6 text-blue-900" id="titre">Nouvelle rÃ©servation</h2>
    <div class="grid md:grid-cols-2 gap-6">
      <input type="hidden" id="id">
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Date d'enlÃ¨vement</label><input type="date" id="enlevement" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Date de restitution</label><input type="date" id="restitution" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Nom</label><input type="text" id="nom" placeholder="Nom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">PrÃ©nom</label><input type="text" id="prenom" placeholder="PrÃ©nom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Email</label><input type="email" id="email" placeholder="email@example.com" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">TÃ©lÃ©phone</label><input type="tel" id="telephone" placeholder="0612345678" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div class="md:col-span-2"><label class="block text-sm font-bold mb-2 text-gray-700">Adresse</label><textarea id="adresse" rows="2" placeholder="Adresse complÃ¨te" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></textarea></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Pseudo</label><input type="text" id="pseudo" placeholder="Pseudo" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
      <div><label class="block text-sm font-bold mb-2 text-gray-700">Template</label><select id="template" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500 cursor-pointer"><option value="">Non</option><option value="Oui">Oui</option></select></div>
      <div class="md:col-span-2 flex gap-4">
        <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg flex-1 transition">ğŸ’¾ Enregistrer</button>
        <button id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-lg font-bold text-lg transition">âŒ Annuler</button>
      </div>
    </div>
  </div>
</div>

<script>
  const URL = "https://script.google.com/macros/s/AKfycbxCjTZax00MtTv3PJ6Vwc2W1s8E6wno9AdCtIk2Eung6H5ycyTHXL9agoFIWsJ-PQvU/exec";
  const PASSWORD = "amax";
  const CLIENT_ID = "Alexis";

  function tel(t) {
    if (!t) return '';
    const str = String(t).replace(/\D/g, '');
    if (str.length === 10) return str.replace(/(\d{2})(?=\d)/g, '$1 ');
    return str;
  }

  async function load() {
    try {
      const r = await fetch(URL + '?clientId=' + CLIENT_ID);
      const j = await r.json();
      console.log('ğŸ“¥ DonnÃ©es:', j);
      const data = j.data || [];
      const filtre = document.getElementById('filtre').value;
      const mois = [...new Set(data.map(x => x.enlevement?.slice(0, 7)))].filter(Boolean).sort().reverse();
      document.getElementById('filtre').innerHTML = '<option value="">Tous les mois</option>' + mois.map(m => '<option value="' + m + '"' + (filtre === m ? ' selected' : '') + '>' + new Date(m + '-01').toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) + '</option>').join('');
      const tbody = document.getElementById('tbody');
      if (data.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="12" class="text-center py-8 text-gray-500">Aucune rÃ©servation</td></tr>'; 
        return; 
      }
      tbody.innerHTML = data.filter(x => !filtre || x.enlevement?.startsWith(filtre)).map(r => {
        const ok = r.contratSigne === 'Oui' && r.acompte === 'Oui';
        const dateEnlevement = r.enlevement ? new Date(r.enlevement).toLocaleDateString('fr-FR') : '-';
        const dateRestitution = r.restitution ? new Date(r.restitution).toLocaleDateString('fr-FR') : '-';
        const telephone = tel(r.telephone || '');
        const nomComplet = (r.nom || '') + ' ' + (r.prenom || '');
        const rowClass = ok ? 'paid' : 'notpaid';
        return '<tr class="' + rowClass + '" data-id="' + r.id + '">' +
          '<td>' + dateEnlevement + '</td>' +
          '<td>' + dateRestitution + '</td>' +
          '<td><strong>' + nomComplet + '</strong></td>' +
          '<td>' + (r.email || '') + '</td>' +
          '<td class="font-mono">' + telephone + '</td>' +
          '<td style="white-space:normal; max-width:250px;">' + (r.adresse || '') + '</td>' +
          '<td>' + (r.pseudo || '') + '</td>' +
          '<td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer chk-signe" data-id="' + r.id + '" ' + (r.contratSigne === 'Oui' ? 'checked' : '') + '></td>' +
          '<td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer chk-acompte" data-id="' + r.id + '" ' + (r.acompte === 'Oui' ? 'checked' : '') + '></td>' +
          '<td class="text-center"><input type="checkbox" class="w-5 h-5 cursor-pointer chk-caution" data-id="' + r.id + '" ' + (r.caution === 'Oui' ? 'checked' : '') + '></td>' +
          '<td>' + (r.template || '') + '</td>' +
          '<td class="text-center whitespace-nowrap">' +
          '<button class="btn-edit text-2xl hover:scale-110 transition mr-2" data-resa=\'' + JSON.stringify(r) + '\' title="Modifier">âœï¸</button>' +
          '<button class="btn-delete text-2xl hover:scale-110 transition" data-id="' + r.id + '" title="Supprimer">ğŸ—‘ï¸</button>' +
          '</td></tr>';
      }).join('');
      
      document.querySelectorAll('.chk-signe').forEach(cb => cb.addEventListener('change', e => maj(e.target.dataset.id, 'contratSigne', e.target.checked)));
      document.querySelectorAll('.chk-acompte').forEach(cb => cb.addEventListener('change', e => maj(e.target.dataset.id, 'acompte', e.target.checked)));
      document.querySelectorAll('.chk-caution').forEach(cb => cb.addEventListener('change', e => maj(e.target.dataset.id, 'caution', e.target.checked)));
      document.querySelectorAll('.btn-edit').forEach(btn => btn.addEventListener('click', e => editer(JSON.parse(e.target.dataset.resa))));
      document.querySelectorAll('.btn-delete').forEach(btn => btn.addEventListener('click', e => supprimer(e.target.dataset.id)));
    } catch (err) {
      console.error('âŒ Erreur:', err);
      document.getElementById('tbody').innerHTML = '<tr><td colspan="12" class="text-center py-8 text-red-500">âŒ Erreur</td></tr>';
    }
  }

  async function maj(id, champ, val) {
    try {
      console.log('ğŸ”„ MAJ:', id, champ, val);
      await fetch(URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ clientId: CLIENT_ID, action: 'update', reservation: { id: parseInt(id), [champ]: val ? 'Oui' : 'Non' } }), mode: 'no-cors' });
      setTimeout(() => load(), 2000);
    } catch (err) {
      console.error('âŒ', err);
      Swal.fire('Erreur', 'Impossible de mettre Ã  jour', 'error');
    }
  }

  function editer(resa) {
    document.getElementById('titre').textContent = 'Modifier';
    document.getElementById('id').value = resa.id;
    document.getElementById('enlevement').value = resa.enlevement;
    document.getElementById('restitution').value = resa.restitution;
    document.getElementById('nom').value = resa.nom || '';
    document.getElementById('prenom').value = resa.prenom || '';
    document.getElementById('email').value = resa.email || '';
    document.getElementById('telephone').value = resa.telephone || '';
    document.getElementById('adresse').value = resa.adresse || '';
    document.getElementById('pseudo').value = resa.pseudo || '';
    document.getElementById('template').value = resa.template || '';
    document.getElementById('modal').classList.remove('hidden');
  }

  async function supprimer(id) {
    const conf = await Swal.fire({ title: 'Supprimer ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc2626', confirmButtonText: 'Oui', cancelButtonText: 'Non' });
    if (conf.isConfirmed) {
      try {
        await fetch(URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ clientId: CLIENT_ID, action: 'delete', id: parseInt(id) }), mode: 'no-cors' });
        setTimeout(() => { load(); Swal.fire('SupprimÃ© !', '', 'success'); }, 1000);
      } catch (err) {
        Swal.fire('Erreur', 'Impossible de supprimer', 'error');
      }
    }
  }

  async function save() {
    const edit = document.getElementById('id').value;
    const resa = {
      id: edit || Date.now().toString(),
      enlevement: document.getElementById('enlevement').value,
      restitution: document.getElementById('restitution').value,
      nom: document.getElementById('nom').value,
      prenom: document.getElementById('prenom').value,
      email: document.getElementById('email').value,
      telephone: document.getElementById('telephone').value,
      adresse: document.getElementById('adresse').value,
      pseudo: document.getElementById('pseudo').value,
      template: document.getElementById('template').value,
      contratSigne: 'Non', acompte: 'Non', caution: 'Non'
    };
    
    console.log('ğŸš€ Envoi:', resa);
    Swal.fire({ title: 'Enregistrement...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
    try {
      await fetch(URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ clientId: CLIENT_ID, action: edit ? 'update' : 'add', reservation: resa }), mode: 'no-cors' });
      await new Promise(r => setTimeout(r, 3000));
      document.getElementById('modal').classList.add('hidden');
      await load();
      Swal.fire('SuccÃ¨s !', 'RÃ©servation enregistrÃ©e et ajoutÃ©e Ã  Google Agenda', 'success');
    } catch (err) {
      console.error('âŒ', err);
      Swal.fire('Erreur', 'ProblÃ¨me de connexion', 'error');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('showPassword').addEventListener('change', function() {
      document.getElementById('password').type = this.checked ? 'text' : 'password';
    });
    
    document.getElementById('loginBtn').addEventListener('click', function() {
      const pass = document.getElementById('password').value;
      console.log('ğŸ”‘ Mot de passe:', pass);
      if (pass === PASSWORD) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        load();
      } else {
        Swal.fire('Erreur', 'Mot de passe incorrect', 'error');
      }
    });
    
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });
    
    document.getElementById('newBtn').addEventListener('click', function() {
      document.getElementById('titre').textContent = 'Nouvelle rÃ©servation';
      document.getElementById('id').value = '';
      document.getElementById('enlevement').value = '';
      document.getElementById('restitution').value = '';
      document.getElementById('nom').value = '';
      document.getElementById('prenom').value = '';
      document.getElementById('email').value = '';
      document.getElementById('telephone').value = '';
      document.getElementById('adresse').value = '';
      document.getElementById('pseudo').value = '';
      document.getElementById('template').value = '';
      document.getElementById('modal').classList.remove('hidden');
    });
    
    document.getElementById('logoutBtn').addEventListener('click', () => location.reload());
    document.getElementById('saveBtn').addEventListener('click', save);
    document.getElementById('cancelBtn').addEventListener('click', () => document.getElementById('modal').classList.add('hidden'));
    document.getElementById('filtre').addEventListener('change', load);
    
    document.getElementById('enlevement').addEventListener('change', function() {
      if (this.value && !document.getElementById('restitution').value) {
        document.getElementById('restitution').value = this.value;
      }
    });
  });
</script>
</body>
</html>
