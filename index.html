<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photobooth - R√©servations</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; min-height: 100vh; background: #f3f4f6; overflow-x: hidden; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #1e40af; color: white; padding: 1rem 0.75rem; position: sticky; top: 0; z-index: 10; white-space: nowrap; text-align: center; font-size: 0.875rem; font-weight: 600; }
    td { padding: 0.875rem 0.75rem; border-bottom: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; }
    tbody tr:hover { background: #f9fafb; }
    .paid { background: #d1fae5; }
    .paid:hover { background: #a7f3d0 !important; }
    .notpaid { background: #fee2e2; }
    .notpaid:hover { background: #fecaca !important; }
  </style>
</head>
<body>

  <!-- PAGE DE CONNEXION -->
  <div id="login" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-900 to-purple-900">
    <div class="bg-white p-10 rounded-2xl shadow-2xl text-center max-w-md w-full mx-4">
      <h1 class="text-4xl font-bold text-blue-900 mb-4">Photobooth</h1>
      <p class="text-gray-600 mb-8">Gestion de vos r√©servations</p>
      <input id="clientCode" type="text" class="w-full p-4 border-2 rounded-lg text-lg mb-4 focus:outline-none focus:border-blue-500 uppercase" placeholder="Identifiant (ex: TUTU)">
      <input id="password" type="password" class="w-full p-4 border-2 rounded-lg text-lg mb-2 focus:outline-none focus:border-blue-500" placeholder="Mot de passe">
      <div class="flex items-center mb-4">
        <input type="checkbox" id="showPassword" class="w-5 h-5 mr-3 cursor-pointer">
        <label for="showPassword" class="text-sm text-gray-700 cursor-pointer select-none">Afficher le mot de passe</label>
      </div>
      <div class="flex items-center mb-6">
        <input type="checkbox" id="rememberMe" class="w-5 h-5 mr-3 cursor-pointer">
        <label for="rememberMe" class="text-sm text-gray-700 cursor-pointer select-none">Se souvenir de moi</label>
      </div>
      <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-lg font-bold text-xl transition">Se connecter</button>
      <p class="mt-6 text-sm text-gray-500">Contactez votre fournisseur pour vos identifiants</p>
    </div>
  </div>

  <!-- APPLICATION -->
  <div id="app" class="hidden">
    <!-- HEADER -->
    <div class="bg-blue-900 shadow-lg">
      <div class="px-4 py-6 max-w-7xl mx-auto">
        <div class="flex flex-wrap justify-between items-center gap-4">
          <div>
            <h1 class="text-3xl font-bold text-white">Mes R√©servations Photobooth</h1>
            <p class="text-blue-200 mt-1">Connect√© : <span id="userName" class="font-bold"></span></p>
          </div>
          <div class="flex gap-3 flex-wrap">
            <select id="filtreMois" onchange="load()" class="px-4 py-2 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500 cursor-pointer">
              <option value="">üìÖ Tous les mois</option>
            </select>
            <button onclick="nouveau()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">+ Nouvelle r√©servation</button>
            <button onclick="openContractEditor()" class="bg-purple-600 hover:bg-purple-800 text-white px-6 py-3 rounded-lg font-bold transition shadow-lg">Modifier mon contrat</button>
            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition">D√©connexion</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CONFIG CLIENT -->
    <div class="bg-yellow-50 border-l-4 border-yellow-500">
      <div class="px-4 py-6 max-w-7xl mx-auto">
        <h3 class="text-2xl font-bold mb-4 text-yellow-900">Configuration Client</h3>
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-bold mb-2 text-gray-700">Votre email Gmail :</label>
            <input id="emailClient" type="email" class="w-full p-4 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500" placeholder="votreemail@gmail.com" onchange="saveEmailConfig()">
          </div>
          <div>
            <label class="block text-sm font-bold mb-2 text-gray-700">Objet du mail :</label>
            <input id="sujet" class="w-full p-4 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500" value="Votre contrat Photobooth - √Ä signer" onchange="saveEmailConfig()">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-bold mb-2 text-gray-700">Corps du mail ({PRENOM} {NOM}) :</label>
            <textarea id="corps" rows="6" class="w-full p-4 border-2 rounded-lg bg-white focus:outline-none focus:border-blue-500" onchange="saveEmailConfig()">Bonjour {PRENOM} {NOM},
Veuillez trouver ci-joint votre contrat de location Photobooth √† signer.
Merci de nous retourner le contrat sign√© accompagn√© de :
- L'acompte de 35‚Ç¨
- Une copie de votre pi√®ce d'identit√©
Cordialement,
L'√©quipe Photobooth</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLEAU -->
    <div class="bg-white min-h-screen">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>üì§ Enl√®vement</th>
              <th>üì• Restitution</th>
              <th>üë§ Nom Pr√©nom</th>
              <th>üìß Email</th>
              <th>üì± T√©l√©phone</th>
              <th>üè† Adresse</th>
              <th>üé≠ Pseudo</th>
              <th>üìÑ Contrat</th>
              <th>‚úâÔ∏è Envoy√©</th>
              <th>‚úÖ Sign√©</th>
              <th>üí∞ Acompte</th>
              <th>üîí Caution</th>
              <th>üé® Template</th>
              <th>‚öôÔ∏è Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="14" class="text-center py-8 text-gray-500">Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL R√âSERVATION -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-screen overflow-y-auto">
      <h2 class="text-3xl font-bold mb-6 text-blue-900" id="titre">Nouvelle r√©servation</h2>
      <form id="form" class="grid md:grid-cols-2 gap-6">
        <input type="hidden" id="id">
        <div><label class="block text-sm font-bold mb-2">Date d'enl√®vement</label><input type="date" id="enlevement" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">Date de restitution</label><input type="date" id="restitution" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">Nom</label><input type="text" id="nom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">Pr√©nom</label><input type="text" id="prenom" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">Email</label><input type="email" id="email" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">T√©l√©phone</label><input type="tel" id="telephone" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div class="md:col-span-2"><label class="block text-sm font-bold mb-2">Adresse</label><textarea id="adresse" rows="2" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></textarea></div>
        <div><label class="block text-sm font-bold mb-2">Pseudo</label><input type="text" id="pseudo" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500"></div>
        <div><label class="block text-sm font-bold mb-2">Template</label>
          <select id="template" class="w-full p-3 border-2 rounded-lg focus:outline-none focus:border-blue-500">
            <option value="">Non</option>
            <option value="Oui">Oui</option>
          </select>
        </div>
        <div class="md:col-span-2 flex gap-4">
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-lg font-bold text-lg flex-1 transition">Enregistrer</button>
          <button type="button" onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-4 rounded-lg font-bold text-lg transition">Annuler</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODALE √âDITEUR DE CONTRAT VISUEL -->
  <div id="contractEditorModal" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl" style="max-height: 90vh; display: flex; flex-direction: column;">
      <div class="bg-blue-900 text-white p-6 rounded-t-2xl text-center">
        <h2 class="text-3xl font-bold">Modifier mon contrat Photobooth</h2>
      </div>
      <div style="flex: 1; overflow-y: auto; padding: 40px;" id="contractPreview" contenteditable="true">
        <!-- Contrat complet charg√© ici -->
      </div>
      <div class="p-6 bg-gray-100 flex justify-center gap-6">
        <button onclick="saveCustomContract()" class="bg-green-600 hover:bg-green-700 text-white px-10 py-4 rounded-lg font-bold text-xl">Sauvegarder mon contrat</button>
        <button onclick="resetToDefaultContract()" class="bg-orange-600 hover:bg-orange-700 text-white px-10 py-4 rounded-lg font-bold text-xl">R√©initialiser</button>
        <button onclick="document.getElementById('contractEditorModal').classList.add('hidden')" class="bg-gray-600 hover:bg-gray-700 text-white px-10 py-4 rounded-lg font-bold text-xl">Fermer</button>
      </div>
    </div>
  </div>

  <script>
    // üî• CONFIGURATION API - URL de votre Google Apps Script
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwm1pNZ8zMr4JhDnvbBTQKpBBqd6N082pWEExo__xfzLtyg05SY5O0tFk-jcrPnwlEHeA/exec';
    
    let dataStore = {};
    let currentClientId = null;

    const CLIENTS = {
      "TUTU": { password: "2025", name: "Tutu" },
      "JEAN2025": { password: "photobooth123", name: "Jean Dupont" },
      "MARIE2025": { password: "party456", name: "Marie Martin" },
      "TEST": { password: "test123", name: "Client Test" }
    };

    // üî• FONCTION POUR CHARGER LES DONN√âES DEPUIS GOOGLE SHEETS
    async function loadDataFromSheets() {
  try {
    const response = await fetch(API_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'get',
        clientId: currentClientId
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      dataStore[currentClientId] = result.data;
      return result.data;
    } else {
      console.error('Erreur chargement:', result.message);
      return [];
    }
  } catch (error) {
    console.error('Erreur r√©seau:', error);
    Swal.fire('Erreur', 'Impossible de charger les donn√©es', 'error');
    return [];
  }
}

    // üî• FONCTION POUR SAUVEGARDER UNE R√âSERVATION
    async function saveReservation(reservation, isUpdate = false) {
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            clientId: currentClientId,
            action: isUpdate ? 'update' : 'add',
            reservation: reservation
          })
        });
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Erreur serveur');
        }
        
        return true;
      } catch (error) {
        console.error('Erreur sauvegarde:', error);
        Swal.fire('Erreur', 'Impossible de sauvegarder: ' + error.message, 'error');
        return false;
      }
    }

    // üî• FONCTION POUR SUPPRIMER UNE R√âSERVATION
    async function deleteReservation(id) {
      try {
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            clientId: currentClientId,
            action: 'delete',
            id: id
          })
        });
        
        const result = await response.json();
        return result.success;
      } catch (error) {
        console.error('Erreur suppression:', error);
        return false;
      }
    }

    // === FONCTION POUR OBTENIR LE CONTRAT COMPLET PAR D√âFAUT ===
    function getDefaultContract() {
      return `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Contrat Photobooth LITE</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 11pt; margin: 40px; line-height: 1.4; }
    h1 { text-align: center; font-size: 14pt; font-weight: bold; margin-bottom: 20px; }
    .section { border: 2px solid black; padding: 15px; margin-bottom: 20px; }
    .section-title { font-weight: bold; text-decoration: underline; margin-bottom: 10px; }
  </style>
</head>
<body>
<h1>Contrat de location Photobooth LITE</h1>
<p style="text-align:center;"><strong>Date :</strong> {DATE}</p>
<div class="section">
  <div class="section-title">Le loueur :</div>
  Mr CHIMOT Alexis<br>3 All√©e Michelet, 34410 Sauvian<br>06.68.17.24.63
</div>
<div class="section">
  <div class="section-title">Le locataire :</div>
  Nom : {NOM}<br>Pr√©nom : {PRENOM}<br>Adresse : {ADRESSE}<br>Email : {EMAIL}<br>T√©l√©phone : {TELEPHONE}
</div>
<div class="section">
  <div class="section-title">La location :</div>
  <p>Du {ENLEVEMENT} √† 17h00 au {RESTITUTION} √† 11h00</p>
  <p>Adresse √©v√©nement : {ADRESSE}</p>
</div>
<div style="margin-top: 80px;">
  <p style="text-align:center;"><strong>Fait le {DATE}</strong></p>
  <table width="100%" style="margin-top: 40px;">
    <tr>
      <td width="50%" style="text-align: center;"><strong>Signature loueur</strong><br><br><br>____________________</td>
      <td width="50%" style="text-align: center;"><strong>Signature locataire</strong><br><br><br>____________________</td>
    </tr>
  </table>
</div>
</body>
</html>`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('showPassword').addEventListener('change', () => {
        const p = document.getElementById('password');
        p.type = document.getElementById('showPassword').checked ? 'text' : 'password';
      });

      const savedCredentials = localStorage.getItem('savedCredentials');
      if (savedCredentials) {
        const creds = JSON.parse(savedCredentials);
        document.getElementById('clientCode').value = creds.clientCode || '';
        document.getElementById('password').value = creds.password || '';
        document.getElementById('rememberMe').checked = true;
      }

      window.login = async function () {
        const code = document.getElementById('clientCode').value.trim().toUpperCase();
        const pass = document.getElementById('password').value;
        const rememberMe = document.getElementById('rememberMe').checked;

        if (!code || !pass) return Swal.fire('Erreur', 'Identifiant et mot de passe requis', 'error');
        const client = CLIENTS[code];
        if (!client || client.password !== pass) return Swal.fire('Erreur', 'Identifiants incorrects', 'error');

        if (rememberMe) {
          localStorage.setItem('savedCredentials', JSON.stringify({ clientCode: code, password: pass }));
        } else {
          localStorage.removeItem('savedCredentials');
        }

        currentClientId = code;
        document.getElementById('login').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        document.getElementById('userName').textContent = client.name;
        
        const savedEmail = localStorage.getItem(`emailConfig_${currentClientId}`);
        if (savedEmail) {
          const config = JSON.parse(savedEmail);
          document.getElementById('emailClient').value = config.email || '';
          document.getElementById('sujet').value = config.sujet || 'Votre contrat Photobooth - √Ä signer';
          document.getElementById('corps').value = config.corps || document.getElementById('corps').value;
        }
        
        await loadDataFromSheets();
        populateMonthFilter();
        load();
      };

      function populateMonthFilter() {
        const data = dataStore[currentClientId] || [];
        const moisSet = new Set();
        
        data.forEach(r => {
          if (r.enlevement) {
            const date = new Date(r.enlevement);
            const moisAnnee = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            moisSet.add(moisAnnee);
          }
        });
        
        const moisArray = Array.from(moisSet).sort().reverse();
        const select = document.getElementById('filtreMois');
        select.innerHTML = '<option value="">üìÖ Tous les mois</option>';
        
        moisArray.forEach(mois => {
          const [annee, moisNum] = mois.split('-');
          const moisNoms = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
          const moisNom = moisNoms[parseInt(moisNum) - 1];
          const option = document.createElement('option');
          option.value = mois;
          option.textContent = `${moisNom} ${annee}`;
          select.appendChild(option);
        });
      }

      window.saveEmailConfig = function() {
        const config = {
          email: document.getElementById('emailClient').value,
          sujet: document.getElementById('sujet').value,
          corps: document.getElementById('corps').value
        };
        localStorage.setItem(`emailConfig_${currentClientId}`, JSON.stringify(config));
      };

      window.load = function () {
        let data = dataStore[currentClientId] || [];
        const filtreMois = document.getElementById('filtreMois').value;
        
        if (filtreMois) {
          data = data.filter(r => {
            if (!r.enlevement) return false;
            const date = new Date(r.enlevement);
            const moisAnnee = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            return moisAnnee === filtreMois;
          });
        }
        
        data.sort((a, b) => {
          const dateA = a.enlevement ? new Date(a.enlevement) : new Date(0);
          const dateB = b.enlevement ? new Date(b.enlevement) : new Date(0);
          return dateB - dateA;
        });
        
        const tbody = document.getElementById('tbody');
        
        tbody.innerHTML = data.length === 0
          ? '<tr><td colspan="14" class="text-center py-8 text-gray-500">Aucune r√©servation</td></tr>'
          : data.map(r => {
              const ok = r.contratSigne === 'Oui' && r.acompte === 'Oui';
              const dateEnl = r.enlevement ? new Date(r.enlevement).toLocaleDateString('fr-FR') : '-';
              const dateRest = r.restitution ? new Date(r.restitution).toLocaleDateString('fr-FR') : '-';
              const tel = r.telephone ? r.telephone.replace(/(\d{2})(?=\d)/g, '$1 ') : '';
              const nomComplet = `${r.prenom || ''} ${r.nom || ''}`.trim();
              return `<tr class="${ok ? 'paid' : 'notpaid'}">
                <td>${dateEnl}</td>
                <td>${dateRest}</td>
                <td><strong>${nomComplet}</strong></td>
                <td>${r.email || ''}</td>
                <td>${tel}</td>
                <td style="white-space:normal;max-width:250px;">${r.adresse || ''}</td>
                <td>${r.pseudo || ''}</td>
                <td><button onclick="generateAndSendContract(${r.id})" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1.5 rounded text-sm font-bold">üìß Contrat</button></td>
                <td><input type="checkbox" class="w-5 h-5" ${r.contratEnvoye === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'contratEnvoye',this.checked)"></td>
                <td><input type="checkbox" class="w-5 h-5" ${r.contratSigne === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'contratSigne',this.checked)"></td>
                <td><input type="checkbox" class="w-5 h-5" ${r.acompte === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'acompte',this.checked)"></td>
                <td><input type="checkbox" class="w-5 h-5" ${r.caution === 'Oui' ? 'checked' : ''} onchange="maj(${r.id},'caution',this.checked)"></td>
                <td>${r.template || ''}</td>
                <td>
                  <button onclick='editer(${JSON.stringify(r)})' class="text-2xl">‚úèÔ∏è</button>
                  <button onclick="supprimer(${r.id})" class="text-2xl">üóëÔ∏è</button>
                </td>
              </tr>`;
            }).join('');
      };

      window.maj = async function(id, champ, checked) {
        const data = dataStore[currentClientId];
        const reservation = data.find(r => r.id === id);
        if (reservation) {
          reservation[champ] = checked ? 'Oui' : 'Non';
          await saveReservation(reservation, true);
          load();
        }
      };

      window.openContractEditor = function () {
        const preview = document.getElementById('contractPreview');
        let html = localStorage.getItem(`contrat_${currentClientId}`);
        if (!html) html = getDefaultContract();
        preview.innerHTML = html;
        document.getElementById('contractEditorModal').classList.remove('hidden');
      };

      window.saveCustomContract = function () {
        const html = document.getElementById('contractPreview').innerHTML;
        localStorage.setItem(`contrat_${currentClientId}`, html);
        Swal.fire('Sauvegard√© !', 'Votre contrat personnalis√© est enregistr√©', 'success');
      };

      window.resetToDefaultContract = function () {
        if (confirm('R√©initialiser le contrat ?')) {
          localStorage.removeItem(`contrat_${currentClientId}`);
          openContractEditor();
        }
      };

      window.generateAndSendContract = function (id) {
        const data = dataStore[currentClientId];
        const r = data.find(x => x.id === id);
        if (!r) return Swal.fire('Erreur', 'R√©servation introuvable', 'error');

        let html = localStorage.getItem(`contrat_${currentClientId}`) || getDefaultContract();
        const today = new Date().toLocaleDateString('fr-FR');
        
        html = html
          .replace(/{PRENOM}/g, r.prenom || '')
          .replace(/{NOM}/g, r.nom || '')
          .replace(/{EMAIL}/g, r.email || '')
          .replace(/{TELEPHONE}/g, r.telephone || '')
          .replace(/{ADRESSE}/g, r.adresse || '')
          .replace(/{ENLEVEMENT}/g, new Date(r.enlevement).toLocaleDateString('fr-FR'))
          .replace(/{RESTITUTION}/g, new Date(r.restitution).toLocaleDateString('fr-FR'))
          .replace(/{DATE}/g, today);

        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
        setTimeout(() => win.print(), 800);

        const sujet = encodeURIComponent(document.getElementById('sujet').value || 'Votre contrat Photobooth');
        let corps = document.getElementById('corps').value
          .replace('{PRENOM}', r.prenom || '')
          .replace('{NOM}', r.nom || '');
        const gmail = `https://mail.google.com/mail/?view=cm&to=${r.email}&su=${sujet}&body=${encodeURIComponent(corps)}`;
        setTimeout(() => window.open(gmail, '_blank'), 1500);
      };

      window.nouveau = function () {
        document.getElementById('titre').textContent = 'Nouvelle r√©servation';
        document.getElementById('form').reset();
        document.getElementById('id').value = '';
        document.getElementById('modal').classList.remove('hidden');
      };

      window.closeModal = function () {
        document.getElementById('modal').classList.add('hidden');
      };

      window.editer = function(resa) {
        document.getElementById('titre').textContent = 'Modifier la r√©servation';
        document.getElementById('id').value = resa.id;
        document.getElementById('enlevement').value = resa.enlevement;
        document.getElementById('restitution').value = resa.restitution;
        document.getElementById('nom').value = resa.nom;
        document.getElementById('prenom').value = resa.prenom;
        document.getElementById('email').value = resa.email;
        document.getElementById('telephone').value = resa.telephone;
        document.getElementById('adresse').value = resa.adresse;
        document.getElementById('pseudo').value = resa.pseudo;
        document.getElementById('template').value = resa.template || '';
        document.getElementById('modal').classList.remove('hidden');
      };

      window.supprimer = async function(id) {
        if (confirm('Supprimer cette r√©servation ?')) {
          const success = await deleteReservation(id);
          if (success) {
            await loadDataFromSheets();
            populateMonthFilter();
            load();
            Swal.fire('Supprim√© !', 'La r√©servation a √©t√© supprim√©e', 'success');
          }
        }
      };

      document.getElementById('form').onsubmit = async (e) => {
        e.preventDefault();
        const edit = document.getElementById('id').value;
        
        const resa = {
          id: edit ? parseInt(edit) : Date.now(),
          enlevement: document.getElementById('enlevement').value,
          restitution: document.getElementById('restitution').value,
          nom: document.getElementById('nom').value,
          prenom: document.getElementById('prenom').value,
          email: document.getElementById('email').value,
          telephone: document.getElementById('telephone').value,
          adresse: document.getElementById('adresse').value,
          pseudo: document.getElementById('pseudo').value,
          template: document.getElementById('template').value,
          contratEnvoye: 'Non',
          contratSigne: 'Non',
          acompte: 'Non',
          caution: 'Non'
        };

        if (edit) {
          const existing = dataStore[currentClientId].find(r => r.id === parseInt(edit));
          if (existing) {
            resa.contratEnvoye = existing.contratEnvoye;
            resa.contratSigne = existing.contratSigne;
            resa.acompte = existing.acompte;
            resa.caution = existing.caution;
          }
        }

        const success = await saveReservation(resa, !!edit);
        if (success) {
          closeModal();
          await loadDataFromSheets();
          populateMonthFilter();
          load();
          Swal.fire('Enregistr√© !', 'La r√©servation a √©t√© enregistr√©e et ajout√©e √† votre Google Agenda', 'success');
        }
      };
    });
  </script>
</body>
</html>
